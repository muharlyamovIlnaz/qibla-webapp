const tg = window.Telegram?.WebApp ?? null;

const btnStart = document.getElementById("btnStart");
const statusEl = document.getElementById("status");
const dialEl   = document.getElementById("dial");
const arrowEl  = document.getElementById("arrow");
const qAzEl    = document.getElementById("qAz");
const hAzEl    = document.getElementById("hAz");

const KAABA_LAT = 21.422487;
const KAABA_LON = 39.826206;

const SMOOTHING = 0.12;

let qiblaAzimuth = null;
let smoothHeading = null;
let rafId = null;

function normalize(a) {
  return (a % 360 + 360) % 360;
}

function shortestDelta(a, b) {
  return ((b - a + 540) % 360) - 180;
}

function smoothAngle(prev, next) {
  return normalize(prev + shortestDelta(prev, next) * SMOOTHING);
}

function calculateQibla(lat, lon) {
  const φ1 = lat * Math.PI/180;
  const φ2 = KAABA_LAT * Math.PI/180;
  const Δλ = (KAABA_LON - lon) * Math.PI/180;

  const y = Math.sin(Δλ) * Math.cos(φ2);
  const x = Math.cos(φ1)*Math.sin(φ2) -
            Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);

  return normalize(Math.atan2(y,x) * 180/Math.PI);
}

function getHeading(e) {
  if (typeof e.webkitCompassHeading === "number") {
    return normalize(e.webkitCompassHeading);
  }
  if (typeof e.alpha === "number") {
    return normalize(360 - e.alpha);
  }
  return null;
}

function onOrientation(e) {
  const h = getHeading(e);
  if (h == null) return;
  smoothHeading = smoothHeading == null ? h : smoothAngle(smoothHeading, h);
}

function render() {
  if (smoothHeading != null) {
    dialEl.style.transform = `rotate(${-smoothHeading}deg)`;
    hAzEl.textContent = smoothHeading.toFixed(1);
  }
  if (qiblaAzimuth != null) {
    arrowEl.style.transform =
      `translate(-50%,-92%) rotate(${qiblaAzimuth}deg)`;
  }
  rafId = requestAnimationFrame(render);
}

btnStart.onclick = async () => {
  try {
    tg?.expand(); tg?.ready();
    btnStart.disabled = true;
    statusEl.textContent = "Получаем доступ…";

    if (DeviceOrientationEvent?.requestPermission) {
      const p = await DeviceOrientationEvent.requestPermission();
      if (p !== "granted") throw new Error("Нет доступа к датчикам");
    }

    const pos = await new Promise((res, rej) =>
      navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy:true })
    );

    qiblaAzimuth = calculateQibla(pos.coords.latitude, pos.coords.longitude);
    qAzEl.textContent = qiblaAzimuth.toFixed(1);

    window.addEventListener("deviceorientation", onOrientation, true);
    window.addEventListener("deviceorientationabsolute", onOrientation, true);

    statusEl.textContent = "Готово. Поворачивайте телефон.";
    if (!rafId) rafId = requestAnimationFrame(render);
  } catch (e) {
    statusEl.textContent = "Ошибка: " + e.message;
    btnStart.disabled = false;
  }
};
