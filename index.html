<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <title>Qibla Compass</title>

    <!-- Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!--
      Anti-cache:
      1) Telegram часто кэширует WebView по URL.
      2) Поэтому мы берем ?v=... из URL и прокидываем в CSS/JS.
      3) Если v нет — ставим "1" (для браузера), а в боте лучше всегда добавлять v.
    -->
    <script>
        (function () {
          const qs = new URLSearchParams(location.search);
          const v = qs.get("v") || "1";
          const link = document.createElement("link");
          link.rel = "stylesheet";
          link.href = "./style.css?v=" + encodeURIComponent(v);
          document.head.appendChild(link);

          const s = document.createElement("script");
          s.src = "./app.js?v=" + encodeURIComponent(v);
          s.defer = true;
          document.head.appendChild(s);
        })();
    </script>
</head>

<body>
<div class="wrap">
    <header class="header">
        <div class="title">Qibla</div>
        <div class="subtitle">Компас направления на Каабу</div>
    </header>

    <section class="card">
        <div id="status" class="status">
            Нажмите «Начать», затем разрешите датчики и геолокацию.
        </div>

        <button id="btnStart" class="btn">Начать</button>

        <div class="compassWrap">
            <div class="compass" aria-label="Qibla compass">
                <!-- Dial rotates by -heading (N/E/S/W rotate together) -->
                <div id="dial" class="dial">
                    <div class="dialRing"></div>

                    <div class="mark n"><span>N</span></div>
                    <div class="mark e"><span>E</span></div>
                    <div class="mark s"><span>S</span></div>
                    <div class="mark w"><span>W</span></div>
                </div>

                <div class="ticks" aria-hidden="true">
                    <i style="--i:0"></i><i style="--i:1"></i><i style="--i:2"></i><i style="--i:3"></i>
                    <i style="--i:4"></i><i style="--i:5"></i><i style="--i:6"></i><i style="--i:7"></i>
                    <i style="--i:8"></i><i style="--i:9"></i><i style="--i:10"></i><i style="--i:11"></i>
                </div>
                <!-- Arrow rotates by (qiblaAzimuth - heading) -->
                <div id="arrow" class="arrow" aria-hidden="true"></div>

                <div class="centerDot" aria-hidden="true"></div>
            </div>
        </div>

        <div class="info">
            <div class="pill">
                <span class="label">Кыбла</span>
                <span id="qAz" class="value">—</span><span class="unit">°</span>
            </div>
            <div class="pill">
                <span class="label">Направление</span>
                <span id="hAz" class="value">—</span><span class="unit">°</span>
            </div>
        </div>

        <div class="hint" id="hint">
            Если компас “плавает”: сделай калибровку (покрути телефон “восьмёркой”), убери магнитный чехол/держатель.
        </div>
    </section>
</div>
</body>
</html>
